# Ising Model 計算物理專案：技術報告與物理理論

## 📋 專案概述

本專案實現了三種計算 2D Ising 模型熱力學性質的演算法：
1. **窮舉法 (Enumeration)** - 直接列舉所有自旋配置
2. **轉移矩陣法 (Transfer Matrix)** - 基於統計力學的矩陣方法
3. **張量重整化群 (Tensor Renormalization Group, TRG)** - 現代數值重整化技術

### 🎯 專案目標
- 計算自由能密度 (Free Energy per Spin)
- 計算磁化率 (Magnetic Susceptibility)
- 計算比熱 (Heat Capacity)
- 分析計算效率和精度權衡

---

## 🧮 物理理論基礎

### 2D Ising 模型

**哈密頓量 (Hamiltonian)**：
```
H = -J ∑_{⟨i,j⟩} σᵢσⱼ - h ∑ᵢ σᵢ
```

其中：
- `σᵢ ∈ {-1, +1}` 為格點 i 的自旋
- `J` 為相鄰自旋交互強度
- `h` 為外磁場
- `⟨i,j⟩` 表示最近鄰格點對

**配分函數 (Partition Function)**：
```
Z = ∑_{所有配置} exp(-βH) = ∑_{σ} exp(-βH(σ))
```

其中 `β = 1/(kᵦT)` 為逆溫度。

**熱力學量計算**：
- **自由能密度**: `f = -T ln(Z)/N`
- **磁化率**: `χ = β(⟨M²⟩ - ⟨M⟩²)/N`
- **比熱**: `C = β²(⟨E²⟩ - ⟨E⟩²)/N`

---

## 🔬 演算法實現詳解

### 1. 窮舉法 (Enumeration Method)

**原理**：直接列舉 `2^N` 個所有可能的自旋配置

**實現細節**：
```python
def enumeration_observables_2d(Lx, Ly, T, J, h):
    N = Lx * Ly
    beta = 1.0 / T
    total_Z = 0.0
    total_energy = 0.0
    
    # 遍歷所有 2^N 個配置
    for config in range(2**N):
        spins = decode_configuration(config, Lx, Ly)
        energy = compute_energy(spins, J, h)
        weight = exp(-beta * energy)
        total_Z += weight
        total_energy += energy * weight
    
    # 計算熱力學量
    free_energy_per_spin = -log(total_Z) / (beta * N)
    return ObservableResult(free_energy_per_spin, ...)
```

**優點**：
- 絕對精確，無近似誤差
- 適合小系統 (N ≤ 16)

**缺點**：
- 計算複雜度 `O(2^N)`，指數增長
- 大系統 (N > 20) 實際不可行

### 2. 轉移矩陣法 (Transfer Matrix Method)

**物理原理**：
將 2D 格點看作 1D 鏈的乘積，每一行之間的相互作用用轉移矩陣描述。

**核心概念**：
```
Z = Tr(T^Ly)
```

其中 `T` 為轉移矩陣，描述相鄰行之間的統計權重。

**轉移矩陣元素**：
```
T_{σ,σ'} = exp(β[J∑ᵢσᵢσ'ᵢ + J∑ᵢσᵢσᵢ₊₁ + h∑ᵢσᵢ])
```

**實現優勢**：
- 計算複雜度 `O(2^Lx × Ly)`
- 對長條形系統 (Lx ≪ Ly) 特別有效
- 精度高，數值穩定

### 3. 張量重整化群 (TRG) 方法

**理論背景**：
TRG 是基於 Levin & Nave (2007) 提出的現代數值重整化技術，將統計力學問題轉化為張量網路計算。

**核心概念**：
1. **張量表示**：每個格點用 4 階張量 `T[up,right,down,left]` 表示
2. **粗粒化**：通過 SVD 分解將 2×2 格點塊收縮為單一有效格點
3. **迭代過程**：重複粗粒化直到系統縮減為單一格點

**TRG 迭代步驟**：

```
第 n 步：Lₙ×Lₙ 格點 → 第 n+1 步：Lₙ₊₁×Lₙ₊₁ 格點
其中 Lₙ₊₁ = Lₙ/2
```

**張量收縮示意圖**：
```
初始：4×4 格點           第1步：2×2 格點        第2步：1×1 格點
┌─┬─┬─┬─┐                ┌───┬───┐             ┌─────────┐
├─┼─┼─┼─┤    TRG       ├───┼───┤   TRG      │  Final  │
├─┼─┼─┼─┤    ───→      ├───┼───┤   ───→     │  Tensor │
└─┴─┴─┴─┘                └───┴───┘             └─────────┘
16 tensors                4 tensors             1 tensor
```

---

## 🚨 當前發現的關鍵問題

### TRG 實現中的根本性錯誤

**問題描述**：
通過系統性診斷，發現 TRG 算法存在根本性的張量收縮錯誤，導致配分函數系統性偏小。

**診斷結果**：
```
測試案例: 2×2 系統, T=2.0, J=1.0, h=0.0
─────────────────────────────────────────
方法         配分函數        誤差倍數
─────────────────────────────────────────
枚舉法       121.23         基準值
TRG (當前)   10.39          11.7× 太小
TRG (目標)   121.23         < 1% 誤差
```

**錯誤來源定位**：
位於 `2d_model.py` 第 523 行的張量收縮公式：

```python
# 🚨 當前錯誤實現
T_new = np.einsum('api,ibj,cjq,qda->abcd', S1, S2, S1, S2)
```

**理論分析**：
1. **重複張量問題**：使用 `(S1, S2, S1, S2)` 不符合 TRG 2×2→1×1 粗粒化的物理圖像
2. **索引對應錯誤**：當前索引收縮不符合真實的格點鄰居關係
3. **算法偏離**：實現偏離了 Levin-Nave 原始論文的標準規範

### 誤差規模分析

**系統性偏差特徵**：
- 2×2 系統：12× 偏差
- 4×4 系統：14,000× 偏差
- 誤差隨系統尺寸指數增長，確認為算法層面錯誤

---

## 🔧 修復策略與理論依據

### 正確的 TRG 張量收縮理論

根據 **Levin & Nave (2007)** 的標準實現，正確的 2×2→1×1 收縮應該：

1. **物理圖像**：
```
   T₁ ──── T₂      收縮內部bonds    T_new
   │       │       ─────────────→   [a,b,c,d]
   │       │
   T₄ ──── T₃
```

2. **數學表達**：
對 2×2 格點的 4 個張量進行內部指標收縮：
```
T_new[a,b,c,d] = ∑_{internal} T₁[a,i,j,d] × T₂[i,b,k,j] × 
                                T₃[j,k,c,l] × T₄[d,l,i,a]
```

3. **SVD 分解形式**：
每個張量通過 SVD 分解為 `T = S1 ⊗ S2` 的形式，正確的收縮公式需要確保：
- 正確的索引對應關係
- 滿足周期性邊界條件
- 保持張量網路的拓撲結構

### 候選修復方案

基於理論分析，提出以下修復候選：

**方案 A：直接四張量收縮** (理論最正確)
```python
T_full = np.einsum('ulb,brd->ulrd', S1, S2)  # 重構完整張量
T_new = np.einsum('aijd,ibjk,cjka,dkai->abcd', T_full, T_full, T_full, T_full)
```

**方案 B：修正的 SVD 收縮** (效率較高)
```python
T_new = np.einsum('ulb,brd,dlb,bru->udlr', S1, S2, S1, S2)
```

**方案 C：索引重新對應** (基於當前結構)
```python
T_new = np.einsum('aui,ivb,cjv,jwa->abcd', S1, S2, S1_prime, S2_prime)
```

---

## 📊 驗證與測試協議

### 立即驗證指標

**核心精度要求**：
```
1. 2×2 系統：|Z_trg - Z_enum|/Z_enum < 1e-6
2. 4×4 系統：|f_trg - f_enum|/|f_enum| < 1e-4
3. 配分函數方向性：修復後應產生 Z > 100 (而非當前 Z ≈ 10)
```

**物理一致性檢查**：
```
1. 對稱性保持：零場下的自旋翻轉對稱性
2. 極限行為：高溫極限 Z → 2^N 的漸近性
3. 熱力學關係：磁化率與自由能導數的一致性
```

### 系統性測試流程

**階段 1：基本修復驗證**
- [x] 診斷當前錯誤規模和來源 ✅
- [ ] 實施候選修復方案
- [ ] 驗證 2×2 系統精度達標

**階段 2：擴展驗證**
- [ ] 4×4 系統精度測試
- [ ] 不同溫度和磁場參數測試
- [ ] 與轉移矩陣法交叉驗證

**階段 3：性能和穩定性**
- [ ] 計算效率分析
- [ ] 數值穩定性測試
- [ ] 大系統 (8×8) 可行性評估

---

## 📈 預期修復效果

**短期目標** (修復完成後)：
- TRG 自由能誤差：從 1.89 → < 1e-4
- 所有單元測試通過
- 物理一致性檢查通過

**中期目標** (系統優化後)：
- 轉移矩陣磁化率誤差：從 1.93e-4 → < 5e-5
- 建立完整的基準測試套件
- 性能優化和可擴展性評估

**長期目標** (研究就緒)：
- 支援更大系統 (8×8, 16×16)
- 相變點附近的精確計算
- 與解析解和蒙地卡羅方法比較

---

## 🔍 技術實現細節

### 檔案結構概述

```
專案根目錄/
├── 2d_model.py              # 主要實現檔案
├── test_2d_model.py         # 單元測試
├── debug_*.py               # 診斷腳本
├── tasks/TASK-001-*/        # 專家分析報告
└── TECH_REPORT.md           # 本技術報告
```

### 關鍵函數說明

**TRG 核心函數**：
```python
def _trg_step(T, chi):
    """TRG 單步粗粒化 - 問題所在函數"""
    
def _build_trg_initial_tensor(beta, J, h):
    """構建初始張量 - 已驗證正確"""
    
def _trg_logZ(Lx, Ly, beta, J, h, chi):
    """TRG 主要邏輯 - 歸一化已修復"""
```

**診斷工具**：
```python
trg_diagnosis.py           # 系統性組件診斷
debug_full_trg.py         # 完整 TRG 流程追蹤
```

---

## 📚 參考文獻與理論基礎

### 核心演算法文獻

1. **Levin, M. & Nave, C.P.** "Tensor renormalization group approach to 2D classical lattice models" *Physical Review Letters* 99, 120601 (2007)
   - TRG 算法的原始提出
   - 標準實現的理論基礎

2. **Baxter, R.J.** "Exactly Solved Models in Statistical Mechanics" (1982)
   - 轉移矩陣法的經典教科書
   - 2D Ising 模型的精確解

### 數值方法參考

3. **Press, W.H. et al.** "Numerical Recipes" Chapter 5
   - SVD 分解的數值實現
   - 數值穩定性考量

4. **Higham, N.J.** "Accuracy and Stability of Numerical Algorithms" (2002)
   - 浮點運算誤差分析
   - 數值方法的穩定性

### 統計力學背景

5. **Kardar, M.** "Statistical Physics of Fields" (2007)
   - 重整化群理論基礎
   - 相變和臨界現象

6. **Goldenfeld, N.** "Lectures on Phase Transitions and the Renormalization Group" (1992)
   - 重整化群的物理圖像
   - 標度理論應用

---

## 🎯 下一步行動計畫

### 立即執行 (今日)
1. **實施 TRG 修復**：基於候選方案測試最佳修復
2. **驗證 2×2 系統**：確保基本案例達到目標精度
3. **記錄修復過程**：完整記錄決策依據和結果

### 短期目標 (1-3 天)
1. **4×4 系統驗證**：確保修復解決實際測試失敗問題
2. **轉移矩陣精度提升**：微調數值參數
3. **完整測試套件**：建立系統性驗證流程

### 中期目標 (1-2 週)
1. **性能優化**：分析計算效率和記憶體使用
2. **擴展性測試**：評估更大系統的可行性
3. **文檔完善**：更新使用說明和 API 文檔

---

## 📝 總結

本專案實現了三種計算 2D Ising 模型的方法，其中發現 TRG 算法存在根本性的張量收縮錯誤。通過系統性診斷，確認問題來源於不正確的 2×2→1×1 粗粒化實現，導致配分函數系統性偏小 10-14,000 倍。

基於 Levin-Nave (2007) 的標準理論，我們已經識別了正確的修復方案，並建立了完整的驗證協議。修復完成後，專案將成為一個可靠的 Ising 模型研究工具，具備高精度計算和良好的數值穩定性。

**當前狀態**：🔴 TRG 關鍵錯誤待修復，🟡 轉移矩陣精度待微調  
**下一步重點**：實施正確的 TRG 張量收縮公式

---

*技術報告版本：v1.0*  
*最後更新：2024-10-02*  
*狀態：TRG 修復進行中*